<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="management.userDAO.BookMapper">
		
	<insert id="insertBook" parameterType="Book">
	insert into book (title, book_id, publisher) values(#{title}, #{book_id}, #{publisher})	
	</insert>
	
	<update id="updateOverdue">
	update bookrental set overdue_date=round(sysdate-(rental_date+7))
	where receive_date is null and sysdate>(rental_date+7)
	</update>	
	
	<select id="findUser" parameterType="String" resultType="User">
	select user_id, user_pw, name, gisu, class as classname, user_pw from BookUser where user_id=#{user_id}
	</select>
	
	<select id="findbook" parameterType="String" resultType="Book">
	select b.book_id, b.title, b.publisher, nvl(f.name,' ' )as rental_name, nvl(s.name, ' ') as reserve_name, 
	r.rental_date, r.receive_date, r.overdue_date
 	from book b full outer join bookrental r on b.book_id=r.book_id 
 	left outer join bookuser f on r.rentalUser_id=f.user_id
 	left outer join bookuser s on r.reserve_id=s.user_id
	where lower(b.title) like lower('%'|| #{title} || '%') 
	</select>
	
	<delete id="deletebook" parameterType="Book">
	delete from Book where book_id=#{book_id}
	</delete>
	
	<select id="findAllbook" resultType="Book">
	select b.book_id, b.title, b.publisher, nvl(f.name,' ' )as rental_name, nvl(s.name, ' ') as reserve_name, 
	r.rental_date, r.receive_date, r.overdue_date
 	from book b left outer join bookrental r on b.book_id=r.book_id 
 	left outer join bookuser f on r.rentalUser_id=f.user_id
 	left outer join bookuser s on r.reserve_id=s.user_id
	</select>
	
	<select id="findRentalBook" resultType="Book">
	select b.book_id, b.title, b.publisher, nvl(f.name,' ' )as rental_name, nvl(s.name, ' ') as reserve_name, 
	r.rental_date, r.receive_date, r.overdue_date
 	from book b join bookrental r on b.book_id=r.book_id 
 	left outer join bookuser f on r.rentalUser_id=f.user_id
 	left outer join bookuser s on r.reserve_id=s.user_id
 	where r.receive_date is null
	</select>
	
	<select id="findOverdueBook" resultType="DBvo">
	select r.rental_id as bookrental_id, b.book_id, b.title, b.publisher, f.name as "rental_name",r.rentalUser_id as rental_id, f.gisu, 
	f.class as classname, r.rental_date, r.overdue_date as overdue
	from book b join bookrental r on b.book_id=r.book_id 
	left outer join bookuser f on r.rentalUser_id=f.user_id 
	left outer join bookuser s on r.reserve_id=s.user_id
	where r.overdue_date>0 and r.receive_date is null
	</select>
	
	<select id="findBookForRent" parameterType="String" resultType="Book">
	select b.book_id, b.title, b.publisher, nvl(f.name,' ' )as rental_name, nvl(s.name, ' ') as reserve_name, 
	r.rental_date, r.receive_date, r.overdue_date
 	from book b full outer join bookrental r on b.book_id=r.book_id 
 	left outer join bookuser f on r.rentalUser_id=f.user_id
 	left outer join bookuser s on r.reserve_id=s.user_id
 	where lower(b.title) like lower('%'|| #{title} || '%') 
	and r.receive_date is null 
	and r.reserve_id is null
	</select>
	
	<select id="findBookForReturn" parameterType="String" resultType="Book">
	select r.rental_id as bookrental_id, b.book_id, b.title, b.publisher, nvl(f.name,' ' )as rental_name, nvl(s.name, ' ') as reserve_name, 
	r.rental_date, r.receive_date, r.overdue_date
 	from book b join bookrental r on b.book_id=r.book_id 
 	left outer join bookuser f on r.rentalUser_id=f.user_id
 	left outer join bookuser s on r.reserve_id=s.user_id
	where  lower(b.title) like lower('%'|| #{title} || '%') 
	and r.receive_date is null and r.rental_date is not null
	</select>
	
	<insert id="rentalBook" parameterType="map">
	insert into bookrental (rental_id, book_id, rental_date, rentaluser_id) 
	values((select nvl(max(rental_id),'0')+1 from bookrental),#{book_id},sysdate,#{user_id})
	</insert>
	
	<update id="updateReceiveDate" parameterType="String">
	update bookrental set receive_date=sysdate where rental_id=#{bookrental_id}
	</update>
	
	<update id="updateReserve" parameterType="map">
	update bookrental set reserve_id = #{user_id} where rental_id = #{bookrental_id}
	</update>
	
</mapper>
